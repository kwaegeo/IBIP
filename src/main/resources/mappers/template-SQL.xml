<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inside.ibip.domain.guest.template.mapper.TemplateMapper">


    <select id="checkTemplate" parameterType="string" resultType="integer">
        SELECT
            count(*)
        FROM
            tb_template
        WHERE
            tmp_nm = #{templateName};
    </select>

    <insert id="insertTemplate" parameterType="com.inside.ibip.domain.guest.template.TemplateVO">
        INSERT INTO
            tb_template
            (
             tmp_id,
             report_id,
             doc_type,
             user_id,
             user_nm,
             reg_ts,
             use_yn,
             tmp_nm,
             remark
             )
        VALUES
            (
            'TE' || TO_CHAR(CURRENT_TIMESTAMP, 'YYMMDDHH24MISS') || LPAD(nextval('seq_tb_template')::text, 6, '0'),
             #{reportId},
             #{docType},
             #{userId},
             #{userNm},
             CURRENT_TIMESTAMP,
             'Y',
             #{tmpNm},
             #{remark}
             )
        <selectKey keyProperty="tmpId" resultType="string" order="AFTER">
            SELECT
                tmp_id
            FROM
                tb_template
            WHERE
                tmp_nm = #{tmpNm}
        </selectKey>
    </insert>
    <insert id="insertPrompts" parameterType="java.util.List">
        INSERT INTO
            tb_prompt
            (
             prpt_id,
             prpt_mstr_id,
             tmp_id,
             prpt_type,
             prpt_nm,
             prpt_desc,
             attr_id
            )
        VALUES
            <foreach collection="list" item="item" separator=",">
            (
            'PR' || TO_CHAR(CURRENT_TIMESTAMP, 'YYMMDDHH24MISS') || LPAD(nextval('seq_tb_prompt')::text, 6, '0'),
             #{item.tmpId},
             #{item.promptId},
             #{item.promptType},
             #{item.promptNm},
             #{item.promptDesc},
             #{item.attrId}
            )
            </foreach>
    </insert>

    <insert id="insertEntity" parameterType="java.util.List">
        INSERT INTO
        tb_entity
        (
        entn_id,
        entn_mstr_id,
        prpt_id,
        entn_type,
        entn_nm,
        default_yn,
        tmp_id
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            'EN' || TO_CHAR(CURRENT_TIMESTAMP, 'YYMMDDHH24MISS') || LPAD(nextval('seq_tb_entity')::text, 6, '0'),
            #{item.entityId},
            #{item.promptId},
            #{item.entityType},
            #{item.entityNm},
            #{item.defaultAnswerYn},
            #{item.tmpId}
            )
        </foreach>
    </insert>

    <insert id="insertElement" parameterType="java.util.List">
        INSERT INTO
        tb_entity
        (
        entn_id,
        entn_mstr_id,
        prpt_id,
        entn_type,
        entn_nm,
        default_yn,
        tmp_id
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            'EN' || TO_CHAR(CURRENT_TIMESTAMP, 'YYMMDDHH24MISS') || LPAD(nextval('seq_tb_entity')::text, 6, '0'),
            #{item.elementId},
            #{item.promptId},
            20000,
            #{item.elementNm},
            #{item.defaultAnswerYn},
            #{item.tmpId}
            )
        </foreach>
    </insert>

    <insert id="insertValue" parameterType="com.inside.ibip.domain.guest.prompt.vo.PromptVO">
        INSERT INTO
        tb_entity
        (
        entn_id,
        entn_mstr_id,
        prpt_id,
        entn_type,
        entn_nm,
        default_yn,
        tmp_id
        )
        VALUES
        (
        'EN' || TO_CHAR(CURRENT_TIMESTAMP, 'YYMMDDHH24MISS') || LPAD(nextval('seq_tb_entity')::text, 6, '0'),
        #{promptId},
        #{promptId},
        10000,
        #{val},
        'N',
        #{tmpId}
        )
    </insert>

    <select id="selectTemplate" resultType="com.inside.ibip.domain.guest.template.TemplateVO">
        SELECT
            tmp_id as tmpId,
            report_id as reportId,
            doc_type as docType,
            user_id as userId,
            user_nm as userNm,
            to_char(reg_ts, 'YYYY-MM-DD HH24:MI:SS') as regTs,
            tmp_nm as tmpNm,
            remark
        FROM
            tb_template
        WHERE
            report_id=#{reportId}
        AND
            user_id=#{userId}
        AND
            use_yn='Y'
    </select>

    <select id="getTemplate" resultType="com.inside.ibip.domain.guest.prompt.vo.ObjectVO">
        SELECT
            entn_mstr_id as entityId,
            prpt_id as promptId,
            entn_nm as entityNm,
            entn_type as entityType
        FROM
            tb_entity
        WHERE
            tmp_id=#{templateId}
    </select>


</mapper>

